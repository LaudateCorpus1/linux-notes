<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>ARM: add support to dump the kernel page tables  [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="icon" href="https://lwn.net/images/favicon.png" type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/newrss">
        <link rel="stylesheet" href="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/lwn.css">
<link rel="stylesheet" href="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/nosub.css">
<link rel="stylesheet" href="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/pure-min.css">
           <!--[if lte IE 8]>
             <link rel="stylesheet" href="/CSS/grids-responsive-old-ie-min">
           <![endif]-->
           <!--[if gt IE 8]><!-->
             <link rel="stylesheet" href="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/grids-responsive-min.css">
           <!--<![endif]-->
           <link rel="stylesheet" href="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/pure-lwn.css">
           
        
<script type="text/javascript" async="" src="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/ados.js"></script><script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body vlink="Green" link="Blue" bgcolor="#ffffff" alink="Green">
        <a name="t"></a>
<div id="menu"><a href="https://lwn.net/"><img src="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/barepenguin-70.png" class="logo" alt="LWN.net Logo" border="0">
           <font class="logo">LWN<br>.net</font>
           <font class="logobl">News from the source</font></a>
           <a href="https://lwn.net/"><img src="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/lcorner-ss.png" class="sslogo" alt="LWN" border="0"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="https://lwn.net/current/">Weekly Edition</a></li><li><a href="https://lwn.net/Archives/">Archives</a></li><li><a href="https://lwn.net/Search/">Search</a></li><li><a href="https://lwn.net/Kernel/">Kernel</a></li><li><a href="https://lwn.net/Security/">Security</a></li><li><a href="https://lwn.net/Distributions/">Distributions</a></li><li><a href="https://lwn.net/Calendar/">Events calendar</a></li><li><a href="https://lwn.net/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="https://lwn.net/op/FAQ.lwn">LWN FAQ</a></li><li><a href="https://lwn.net/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="https://lwn.net/Articles/571558/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="pure-g not-handset" style="margin-left: 10.5em">
           <div class="not-print">
             <div id="azk13321_leaderboard"></div>
           </div>
           </div>
        <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform" class="loginform">
        <b>User:</b> <input type="text" name="Username" size="8"> <b>Password:</b> <input type="password" name="Password" size="8"> <input type="hidden" name="target" value="/Articles/572320/"> <input type="submit" name="submit" value="Log in"></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe">
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register">
           </form>
        </div>
               <div class="handset-only">
               <a href="https://lwn.net/subscribe/"><b>Subscribe</b></a> /
               <a href="https://lwn.net/Login/"><b>Log in</b></a> /
               <a href="https://lwn.net/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="pure-grid maincolumn">
<div class="lwn-u-1 pure-u-md-19-24">
<div class="PageHeadline">
<h1>ARM: add support to dump the kernel page tables </h1>
</div>
<div class="ArticleText">
<table>
<tbody><tr><td valign="top"><b>From</b>:</td>
    	     <td>&nbsp;</td><td valign="top">Russell King - ARM Linux &lt;linux@arm.linux.org.uk&gt; </td></tr>
<tr><td valign="top"><b>To</b>:</td>
    	     <td>&nbsp;</td><td valign="top">linux-arm-kernel@lists.infradead.org </td></tr>
<tr><td valign="top"><b>Subject</b>:</td>
    	     <td>&nbsp;</td><td valign="top">ARM: add support to dump the kernel page tables </td></tr>
<tr><td valign="top"><b>Date</b>:</td>
    	     <td>&nbsp;</td><td valign="top">Thu, 24 Oct 2013 08:16:00 +0100</td></tr>
<tr><td valign="top"><b>Message-ID</b>:</td>
    	     <td>&nbsp;</td><td valign="top">&lt;20131024071600.GC16735@n2100.arm.linux.org.uk&gt;</td></tr>
<tr><td valign="top"><b>Cc</b>:</td>
    	     <td>&nbsp;</td><td valign="top">linux-arch@vger.kernel.org</td></tr>
<tr><td valign="top"><b>Archive-link</b>:</td>
    	     <td>&nbsp;</td><td valign="top"><a href="http://article.gmane.org/gmane.linux.kernel.cross-arch/19992">Article</a>, <a href="http://thread.gmane.org/gmane.linux.kernel.cross-arch/19992">Thread</a>
        </td></tr>
</tbody></table><p>
</p><pre>This is very similar to x86.  I'm just throwing the patch out if people
wish to use this to look at things; I'm going to be working on merging
it with the x86 version, and hopefully we can have the bulk of this
support provided in a generic way such that architectures just need to
define some bitfield data, macros and region data.

8&lt;===
From: Russell King &lt;rmk+kernel@arm.linux.org.uk&gt;
ARM: add support to dump the kernel page tables

This patch allows the kernel page tables to be dumped via a debugfs file,
allowing kernel developers to check the layout of the kernel page tables
and the verify the various permissions and type settings.

Signed-off-by: Russell King &lt;rmk+kernel@arm.linux.org.uk&gt;
---
 arch/arm/Kconfig.debug                |   12 ++
 arch/arm/include/asm/pgtable-2level.h |    1 +
 arch/arm/include/asm/pgtable-3level.h |    1 +
 arch/arm/mm/Makefile                  |    1 +
 arch/arm/mm/dump.c                    |  328 +++++++++++++++++++++++++++++++++
 5 files changed, 343 insertions(+), 0 deletions(-)
 create mode 100644 arch/arm/mm/dump.c

diff --git a/arch/arm/Kconfig.debug b/arch/arm/Kconfig.debug
index 583f4a0..261cc75 100644
--- a/arch/arm/Kconfig.debug
+++ b/arch/arm/Kconfig.debug
@@ -2,6 +2,18 @@ menu "Kernel hacking"
 
 source "lib/Kconfig.debug"
 
+config ARM_PTDUMP
+	bool "Export kernel pagetable layout ot userspace via debugfs"
+	depends on DEBUG_KERNEL
+	select DEBUG_FS
+	---help---
+	  Say Y here if you want to show the kernel pagetable layout in a
+	  debugfs file. This information is only useful for kernel developers
+	  who are working in architecture specific areas of the kernel.
+	  It is probably not a good idea to enable this feature in a production
+	  kernel.
+	  If in doubt, say "N"
+
 config STRICT_DEVMEM
 	bool "Filter access to /dev/mem"
 	depends on MMU
diff --git a/arch/arm/include/asm/pgtable-2level.h b/arch/arm/include/asm/pgtable-2level.h
index f97ee02..b082d00 100644
--- a/arch/arm/include/asm/pgtable-2level.h
+++ b/arch/arm/include/asm/pgtable-2level.h
@@ -160,6 +160,7 @@ static inline pmd_t *pmd_offset(pud_t *pud, unsigned long addr)
 	return (pmd_t *)pud;
 }
 
+#define pmd_large(pmd)		(pmd_val(pmd) &amp; 2)
 #define pmd_bad(pmd)		(pmd_val(pmd) &amp; 2)
 
 #define copy_pmd(pmdpd,pmdps)		\
diff --git a/arch/arm/include/asm/pgtable-3level.h b/arch/arm/include/asm/pgtable-3level.h
index 5689c18..d7682cd 100644
--- a/arch/arm/include/asm/pgtable-3level.h
+++ b/arch/arm/include/asm/pgtable-3level.h
@@ -140,6 +140,7 @@
 						 PMD_TYPE_TABLE)
 #define pmd_sect(pmd)		((pmd_val(pmd) &amp; PMD_TYPE_MASK) == \
 						 PMD_TYPE_SECT)
+#define pmd_large(pmd)		pmd_sect(pmd)
 
 #define pud_clear(pudp)			\
 	do {				\
diff --git a/arch/arm/mm/Makefile b/arch/arm/mm/Makefile
index ecfe6e5..7f39ce2 100644
--- a/arch/arm/mm/Makefile
+++ b/arch/arm/mm/Makefile
@@ -12,6 +12,7 @@ ifneq ($(CONFIG_MMU),y)
 obj-y				+= nommu.o
 endif
 
+obj-$(CONFIG_ARM_PTDUMP)	+= dump.o
 obj-$(CONFIG_MODULES)		+= proc-syms.o
 
 obj-$(CONFIG_ALIGNMENT_TRAP)	+= alignment.o
diff --git a/arch/arm/mm/dump.c b/arch/arm/mm/dump.c
new file mode 100644
index 0000000..4979d4c
--- /dev/null
+++ b/arch/arm/mm/dump.c
@@ -0,0 +1,328 @@
+/*
+ * Debug helper to dump the current kernel pagetables of the system
+ * so that we can see what the various memory ranges are set to.
+ *
+ * Derived from x86 implementation:
+ * (C) Copyright 2008 Intel Corporation
+ *
+ * Author: Arjan van de Ven &lt;arjan@linux.intel.com&gt;
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; version 2
+ * of the License.
+ */
+#include &lt;linux/debugfs.h&gt;
+#include &lt;linux/fs.h&gt;
+#include &lt;linux/mm.h&gt;
+#include &lt;linux/seq_file.h&gt;
+
+#include &lt;asm/fixmap.h&gt;
+#include &lt;asm/pgtable.h&gt;
+
+struct addr_marker {
+	unsigned long start_address;
+	const char *name;
+};
+
+static struct addr_marker address_markers[] = {
+	{ MODULES_VADDR,	"Modules" },
+	{ PAGE_OFFSET,		"Kernel Mapping" },
+	{ 0,			"vmalloc() Area" },
+	{ VMALLOC_END,		"vmalloc() End" },
+	{ FIXADDR_START,	"Fixmap Area" },
+	{ CONFIG_VECTORS_BASE,	"Vectors" },
+	{ CONFIG_VECTORS_BASE + PAGE_SIZE * 2, "Vectors End" },
+	{ -1,			NULL },
+};
+
+struct pg_state {
+	struct seq_file *seq;
+	const struct addr_marker *marker;
+	unsigned long start_address;
+	unsigned level;
+	u64 current_prot;
+};
+
+struct prot_bits {
+	u64		mask;
+	u64		val;
+	const char	*set;
+	const char	*clear;
+};
+
+static const struct prot_bits pte_bits[] = {
+	{
+		.mask	= L_PTE_USER,
+		.val	= L_PTE_USER,
+		.set	= "USR",
+		.clear	= "   ",
+	}, {
+		.mask	= L_PTE_RDONLY,
+		.val	= L_PTE_RDONLY,
+		.set	= "ro",
+		.clear	= "RW",
+	}, {
+		.mask	= L_PTE_XN,
+		.val	= L_PTE_XN,
+		.set	= "NX",
+		.clear	= "x ",
+	}, {
+		.mask	= L_PTE_SHARED,
+		.val	= L_PTE_SHARED,
+		.set	= "SHD",
+		.clear	= "   ",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_UNCACHED,
+		.set	= "SO/UNCACHED",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_BUFFERABLE,
+		.set	= "MEM/BUFFERABLE/WC",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_WRITETHROUGH,
+		.set	= "MEM/CACHED/WT",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_WRITEBACK,
+		.set	= "MEM/CACHED/WBRA",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_MINICACHE,
+		.set	= "MEM/MINICACHE",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_WRITEALLOC,
+		.set	= "MEM/CACHED/WBWA",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_DEV_SHARED,
+		.set	= "DEV/SHARED",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_DEV_NONSHARED,
+		.set	= "DEV/NONSHARED",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_DEV_WC,
+		.set	= "DEV/WC",
+	}, {
+		.mask	= L_PTE_MT_MASK,
+		.val	= L_PTE_MT_DEV_CACHED,
+		.set	= "DEV/CACHED",
+	},
+};
+
+static const struct prot_bits section_bits[] = {
+	/* These are approximate */
+	{
+		.mask	= PMD_SECT_AP_READ | PMD_SECT_AP_WRITE,
+		.val	= 0,
+		.set	= "    ro",
+	}, {
+		.mask	= PMD_SECT_AP_READ | PMD_SECT_AP_WRITE,
+		.val	= PMD_SECT_AP_WRITE,
+		.set	= "    RW",
+	}, {
+		.mask	= PMD_SECT_AP_READ | PMD_SECT_AP_WRITE,
+		.val	= PMD_SECT_AP_READ,
+		.set	= "USR RO",
+	}, {
+		.mask	= PMD_SECT_AP_READ | PMD_SECT_AP_WRITE,
+		.val	= PMD_SECT_AP_READ | PMD_SECT_AP_WRITE,
+		.set	= "USR RW",
+	}, {
+		.mask	= PMD_SECT_XN,
+		.val	= PMD_SECT_XN,
+		.set	= "NX",
+		.clear	= "x ",
+	}, {
+		.mask	= PMD_SECT_S,
+		.val	= PMD_SECT_S,
+		.set	= "SHD",
+		.clear	= "   ",
+	},
+};
+
+struct pg_level {
+	const struct prot_bits *bits;
+	size_t num;
+	u64 mask;
+};
+
+static struct pg_level pg_level[] = {
+	{
+	}, { /* pgd */
+	}, { /* pud */
+	}, { /* pmd */
+		.bits	= section_bits,
+		.num	= ARRAY_SIZE(section_bits),
+	}, { /* pte */
+		.bits	= pte_bits,
+		.num	= ARRAY_SIZE(pte_bits),
+	},
+};
+
+static void dump_prot(struct pg_state *st, const struct prot_bits *bits, size_t num)
+{
+	unsigned i;
+
+	for (i = 0; i &lt; num; i++, bits++) {
+		const char *s;
+
+		if ((st-&gt;current_prot &amp; bits-&gt;mask) == bits-&gt;val)
+			s = bits-&gt;set;
+		else
+			s = bits-&gt;clear;
+
+		if (s)
+			seq_printf(st-&gt;seq, " %s", s);
+	}
+}
+
+static void note_page(struct pg_state *st, unsigned long addr, unsigned level, u64 val)
+{
+	static const char units[] = "KMGTPE";
+	u64 prot = val &amp; pg_level[level].mask;
+
+	if (addr &lt; USER_PGTABLES_CEILING)
+		return;
+
+	if (!st-&gt;level) {
+		st-&gt;level = level;
+		st-&gt;current_prot = prot;
+		seq_printf(st-&gt;seq, "---[ %s ]---\n", st-&gt;marker-&gt;name);
+	} else if (prot != st-&gt;current_prot || level != st-&gt;level ||
+		   addr &gt;= st-&gt;marker[1].start_address) {
+		const char *unit = units;
+		unsigned long delta;
+
+		if (st-&gt;current_prot) {
+			seq_printf(st-&gt;seq, "0x%08lx-0x%08lx   ",
+				   st-&gt;start_address, addr);
+
+			delta = (addr - st-&gt;start_address) &gt;&gt; 10;
+			while (!(delta &amp; 1023) &amp;&amp; unit[1]) {
+				delta &gt;&gt;= 10;
+				unit++;
+			}
+			seq_printf(st-&gt;seq, "%9lu%c", delta, *unit);
+			if (pg_level[st-&gt;level].bits)
+				dump_prot(st, pg_level[st-&gt;level].bits, pg_level[st-&gt;level].num);
+			seq_printf(st-&gt;seq, "\n");
+		}
+
+		if (addr &gt;= st-&gt;marker[1].start_address) {
+			st-&gt;marker++;
+			seq_printf(st-&gt;seq, "---[ %s ]---\n", st-&gt;marker-&gt;name);
+		}
+		st-&gt;start_address = addr;
+		st-&gt;current_prot = prot;
+		st-&gt;level = level;
+	}
+}
+
+static void walk_pte(struct pg_state *st, pmd_t *pmd, unsigned long start)
+{
+	pte_t *pte = pte_offset_kernel(pmd, 0);
+	unsigned long addr;
+	unsigned i;
+
+	for (i = 0; i &lt; PTRS_PER_PTE; i++, pte++) {
+		addr = start + i * PAGE_SIZE;
+		note_page(st, addr, 4, pte_val(*pte));
+	}
+}
+
+static void walk_pmd(struct pg_state *st, pud_t *pud, unsigned long start)
+{
+	pmd_t *pmd = pmd_offset(pud, 0);
+	unsigned long addr;
+	unsigned i;
+
+	for (i = 0; i &lt; PTRS_PER_PMD; i++, pmd++) {
+		addr = start + i * PMD_SIZE;
+		if (pmd_none(*pmd) || pmd_large(*pmd) || !pmd_present(*pmd))
+			note_page(st, addr, 3, pmd_val(*pmd));
+		else
+			walk_pte(st, pmd, addr);
+	}
+}
+
+static void walk_pud(struct pg_state *st, pgd_t *pgd, unsigned long start)
+{
+	pud_t *pud = pud_offset(pgd, 0);
+	unsigned long addr;
+	unsigned i;
+
+	for (i = 0; i &lt; PTRS_PER_PUD; i++, pud++) {
+		addr = start + i * PUD_SIZE;
+		if (!pud_none(*pud)) {
+			walk_pmd(st, pud, addr);
+		} else {
+			note_page(st, addr, 2, pud_val(*pud));
+		}
+	}
+}
+
+static void walk_pgd(struct seq_file *m)
+{
+	pgd_t *pgd = swapper_pg_dir;
+	struct pg_state st;
+	unsigned long addr;
+	unsigned i;
+
+	memset(&amp;st, 0, sizeof(st));
+	st.seq = m;
+	st.marker = address_markers;
+
+	for (i = USER_PGTABLES_CEILING / PGDIR_SIZE;
+	     i &lt; PTRS_PER_PGD; i++, pgd++) {
+		addr = i * PGDIR_SIZE;
+		if (!pgd_none(*pgd)) {
+			walk_pud(&amp;st, pgd, addr);
+		} else {
+			note_page(&amp;st, addr, 1, pgd_val(*pgd));
+		}
+	}
+
+	note_page(&amp;st, 0, 0, 0);
+}
+
+static int ptdump_show(struct seq_file *m, void *v)
+{
+	walk_pgd(m);
+	return 0;
+}
+
+static int ptdump_open(struct inode *inode, struct file *file)
+{
+	return single_open(file, ptdump_show, NULL);
+}
+
+static const struct file_operations ptdump_fops = {
+	.open		= ptdump_open,
+	.read		= seq_read,
+	.llseek		= seq_lseek,
+	.release	= single_release,
+};
+
+static int ptdump_init(void)
+{
+	struct dentry *pe;
+	unsigned i, j;
+
+	for (i = 0; i &lt; ARRAY_SIZE(pg_level); i++)
+		if (pg_level[i].bits)
+			for (j = 0; j &lt; pg_level[i].num; j++)
+				pg_level[i].mask |= pg_level[i].bits[j].mask;
+
+	address_markers[2].start_address = VMALLOC_START;
+
+	pe = debugfs_create_file("kernel_page_tables", 0400, NULL, NULL,
+				 &amp;ptdump_fops);
+	return pe ? 0 : -ENOMEM;
+}
+__initcall(ptdump_init);
-- 
1.7.4.4


</pre>

</div> <!-- ArticleText -->
</div>
<div class="lwn-u-1 pure-u-md-1-6 not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- pure-grid -->

        <br clear="all">
        <center>
        <p>
        <font size="-2">
        Copyright © 2013, Eklektix, Inc.<br>
        
        Comments and public postings are copyrighted by their creators.<br>
        Linux  is a registered trademark of Linus Torvalds<br>
        </font>
        </p></center>
        
            <script data-goatcounter="https://gc.lwn.net/count" async="" src="ARM%20add%20support%20to%20dump%20the%20kernel%20page%20tables%20[LWN.net]_files/count.js"></script>
            
        
        </body></html>