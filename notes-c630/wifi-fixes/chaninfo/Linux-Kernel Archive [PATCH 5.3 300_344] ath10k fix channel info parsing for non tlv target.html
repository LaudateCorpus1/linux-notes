<!-- MHonArc v2.6.16 -->
<!--X-Subject: [PATCH 5.3 300/344] ath10k: fix channel info parsing for non tlv target -->
<!--X-From-R13: Uert Yebnu&#45;Vnegzna <tertxuNyvahksbhaqngvba.bet> -->
<!--X-Date: Thu,  3 Oct 2019 12:55:45 &#45;0400 (EDT) -->
<!--X-Message-Id: 20191003154609.079936462@linuxfoundation.org -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20191003154540.062170222@linuxfoundation.org -->
<!--X-Head-End-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Linux-Kernel Archive: [PATCH 5.3 300/344] ath10k: fix channel info parsing for non tlv target</title>
<meta name="Author" content="Greg Kroah-Hartman &lt;gregkh@xxxxxxxxxxxxxxxxxxx&gt;">
<meta name="Subject" content="[PATCH 5.3 300/344] ath10k: fix channel info parsing for non tlv target">
</head> 
<body text="#000000" bgcolor="#FFFFFF">

<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->


<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[PATCH 5.3 300/344] ath10k: fix channel info parsing for non tlv target</h1>
<strong>From: </strong>Greg Kroah-Hartman
<br><strong>Date: </strong> Thu Oct 03 2019 - 12:55:45 EST
<p>
</p><ul>
<li><strong>Next message: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04113.html"> Greg Kroah-Hartman: "[PATCH 5.3 267/344] KVM: x86/mmu: Use fast invalidate mechanism to zap MMIO sptes"</a>

</li><li><strong>Previous message: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04111.html"> Linus Torvalds: "Re: [PATCH v3 3/7] mm: Add write-protect and clean utilities for address space ranges"</a>

</li><li><strong>In reply to: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04110.html"> Greg Kroah-Hartman: "[PATCH 5.3 311/344] btrfs: Relinquish CPUs in btrfs_compare_trees"</a>

</li><li><strong>Next in thread: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04113.html"> Greg Kroah-Hartman: "[PATCH 5.3 267/344] KVM: x86/mmu: Use fast invalidate mechanism to zap MMIO sptes"</a>

</li><li><strong>Messages sorted by: </strong><a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/date.html#04112">[ date ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/index.html#04112">[ thread ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/subject.html#04112">[ subject ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/author.html#04112">[ author ]</a>
</li></ul>

<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr noshade="noshade">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
From: Rakesh Pillai &lt;pillair@xxxxxxxxxxxxxx&gt;<br>
<br>
commit 6be6c04bcc2e8770b8637632789ff15765124894 upstream.<br>
<br>
The tlv targets such as WCN3990 send more data in the chan info event, which is<br>
not sent by the non tlv targets. There is a minimum size check in the wmi event<br>
for non-tlv targets and hence we cannot update the common channel info<br>
structure as it was done in commit 13104929d2ec ("ath10k: fill the channel<br>
survey results for WCN3990 correctly"). This broke channel survey results on<br>
10.x firmware versions.<br>
<br>
If the common channel info structure is updated, the size check for chan info<br>
event for non-tlv targets will fail and return -EPROTO and we see the below<br>
error messages<br>
<br>
   ath10k_pci 0000:01:00.0: failed to parse chan info event: -71<br>
<br>
Add tlv specific channel info structure and restore the original size of the<br>
common channel info structure to mitigate this issue.<br>
<br>
Tested HW: WCN3990<br>
	   QCA9887<br>
Tested FW: WLAN.HL.3.1-00784-QCAHLSWMTPLZ-1<br>
	   10.2.4-1.0-00037<br>
<br>
Fixes: 13104929d2ec ("ath10k: fill the channel survey results for WCN3990 correctly")<br>
Cc: stable@xxxxxxxxxxxxxxx # 5.0<br>
Signed-off-by: Rakesh Pillai &lt;pillair@xxxxxxxxxxxxxx&gt;<br>
Signed-off-by: Kalle Valo &lt;kvalo@xxxxxxxxxxxxxx&gt;<br>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@xxxxxxxxxxxxxxxxxxx&gt;<br>
<br>
---<br>
 drivers/net/wireless/ath/ath10k/wmi-tlv.c |    2 +-<br>
 drivers/net/wireless/ath/ath10k/wmi-tlv.h |   16 ++++++++++++++++<br>
 drivers/net/wireless/ath/ath10k/wmi.h     |    8 --------<br>
 3 files changed, 17 insertions(+), 9 deletions(-)<br>
<br>
--- a/drivers/net/wireless/ath/ath10k/wmi-tlv.c<br>
+++ b/drivers/net/wireless/ath/ath10k/wmi-tlv.c<br>
@@ -841,7 +841,7 @@ static int ath10k_wmi_tlv_op_pull_ch_inf<br>
 					     struct wmi_ch_info_ev_arg *arg)<br>
 {<br>
 	const void **tb;<br>
-	const struct wmi_chan_info_event *ev;<br>
+	const struct wmi_tlv_chan_info_event *ev;<br>
 	int ret;<br>
 <br>
 	tb = ath10k_wmi_tlv_parse_alloc(ar, skb-&gt;data, skb-&gt;len, GFP_ATOMIC);<br>
--- a/drivers/net/wireless/ath/ath10k/wmi-tlv.h<br>
+++ b/drivers/net/wireless/ath/ath10k/wmi-tlv.h<br>
@@ -1615,6 +1615,22 @@ struct chan_info_params {<br>
 <br>
 #define WMI_TLV_FLAG_MGMT_BUNDLE_TX_COMPL	BIT(9)<br>
 <br>
+struct wmi_tlv_chan_info_event {<br>
+	__le32 err_code;<br>
+	__le32 freq;<br>
+	__le32 cmd_flags;<br>
+	__le32 noise_floor;<br>
+	__le32 rx_clear_count;<br>
+	__le32 cycle_count;<br>
+	__le32 chan_tx_pwr_range;<br>
+	__le32 chan_tx_pwr_tp;<br>
+	__le32 rx_frame_count;<br>
+	__le32 my_bss_rx_cycle_count;<br>
+	__le32 rx_11b_mode_data_duration;<br>
+	__le32 tx_frame_cnt;<br>
+	__le32 mac_clk_mhz;<br>
+} __packed;<br>
+<br>
 struct wmi_tlv_mgmt_tx_compl_ev {<br>
 	__le32 desc_id;<br>
 	__le32 status;<br>
--- a/drivers/net/wireless/ath/ath10k/wmi.h<br>
+++ b/drivers/net/wireless/ath/ath10k/wmi.h<br>
@@ -6533,14 +6533,6 @@ struct wmi_chan_info_event {<br>
 	__le32 noise_floor;<br>
 	__le32 rx_clear_count;<br>
 	__le32 cycle_count;<br>
-	__le32 chan_tx_pwr_range;<br>
-	__le32 chan_tx_pwr_tp;<br>
-	__le32 rx_frame_count;<br>
-	__le32 my_bss_rx_cycle_count;<br>
-	__le32 rx_11b_mode_data_duration;<br>
-	__le32 tx_frame_cnt;<br>
-	__le32 mac_clk_mhz;<br>
-<br>
 } __packed;<br>
 <br>
 struct wmi_10_4_chan_info_event {<br>
<br>
<br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr noshade="noshade">
<!--X-Follow-Ups-End-->
<!--X-References-->



<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li><strong>Next message: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04113.html"> Greg Kroah-Hartman: "[PATCH 5.3 267/344] KVM: x86/mmu: Use fast invalidate mechanism to zap MMIO sptes"</a>

</li><li><strong>Previous message: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04111.html"> Linus Torvalds: "Re: [PATCH v3 3/7] mm: Add write-protect and clean utilities for address space ranges"</a>

</li><li><strong>In reply to: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04110.html"> Greg Kroah-Hartman: "[PATCH 5.3 311/344] btrfs: Relinquish CPUs in btrfs_compare_trees"</a>

</li><li><strong>Next in thread: </strong> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/04113.html"> Greg Kroah-Hartman: "[PATCH 5.3 267/344] KVM: x86/mmu: Use fast invalidate mechanism to zap MMIO sptes"</a>

</li><li><strong>Messages sorted by: </strong><a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/date.html#04112">[ date ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/index.html#04112">[ thread ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/subject.html#04112">[ subject ]</a> <a href="http://lkml.iu.edu/hypermail/linux/kernel/1910.0/author.html#04112">[ author ]</a>
</li></ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->


</body></html>